<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level JSON Reader</title>
</head>

<body>
    <div class="file-selectors">
        <label for="file">Choose a Level File:
            <input type="file" name="file" id="file" accept=".level">
        </label>
        <br>
        <label for="verified-file">Choose a Verified Level File:
            <input type="file" name="verified-file" id="verified-file" accept=".level">
        </label>
        <button id="add-verified">Add Verified Level</button>
    </div>

    <div id="console-output"></div>

    <script src="//cdn.jsdelivr.net/npm/protobufjs@7.X.X/dist/protobuf.js"></script>
    <script type="text/javascript">
        let levelData = null;
        let verifiedDataArray = [];

        document.getElementById('file').addEventListener("change", function (e) {
            const file = e.target.files[0];
            if (file) {
                readLevelFile(file);
            }
        }, false);

        document.getElementById('verified-file').addEventListener("change", function (e) {
            const verifiedFile = e.target.files[0];
            if (verifiedFile) {
                readVerifiedLevelFile(verifiedFile);
            }
        }, false);

        document.getElementById('add-verified').addEventListener("click", function () {
            const verifiedFileInput = document.getElementById('verified-file');
            const verifiedFile = verifiedFileInput.files[0];
            if (verifiedFile) {
                readVerifiedLevelFile(verifiedFile);
                verifiedFileInput.value = null; // Clear input
            }
        });

        function readLevelFile(file) {
            const reader = new FileReader();
            reader.onload = function () {
                const data = reader.result;
                protobuf.load("proto/level.proto", function (err, root) {
                    if (err) throw err;
                    const message = root.lookupType("COD.Level.Level");
                    const decoded = message.decode(new Uint8Array(data));
                    levelData = message.toObject(decoded);
                    console.log(levelData);
                    displayLevelInfo(levelData);
                    compareDataPatterns();
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function readVerifiedLevelFile(file) {
            const reader = new FileReader();
            reader.onload = function () {
                const data = reader.result;
                protobuf.load("proto/level.proto", function (err, root) {
                    if (err) throw err;
                    const message = root.lookupType("COD.Level.Level");
                    const decoded = message.decode(new Uint8Array(data));
                    const verifiedData = message.toObject(decoded);
                    console.log(verifiedData);
                    verifiedDataArray.push(verifiedData);
                    compareDataPatterns();
                });
            };
            reader.readAsArrayBuffer(file);
        }

        function displayLevelInfo(levelData) {
            const consoleOutput = document.getElementById('console-output');
            consoleOutput.innerHTML = "<pre>" + JSON.stringify(levelData, null, 4) + "</pre>";
        }

        function compareDataPatterns() {
            if (levelData && verifiedDataArray.length > 0) {
                console.log("Similarity Values:");
                for (const verifiedData of verifiedDataArray) {
                    const similarity = calculateSimilarity(levelData, verifiedData);
                    console.log(similarity);
                    const threshold = 0.8;
                    if (similarity >= threshold) {
                        const verificationResult = "Verified";
                        const consoleOutput = document.getElementById('console-output');
                        consoleOutput.innerHTML = `<pre>Verification Result: ${verificationResult}</pre>`;
                        return;
                    }
                }
                const verificationResult = "Not Verified";
                const consoleOutput = document.getElementById('console-output');
                consoleOutput.innerHTML = `<pre>Verification Result: ${verificationResult}</pre>`;
            }
        }

        function calculateSimilarity(obj1, obj2) {
            const set1 = new Set(Object.keys(obj1));
            const set2 = new Set(Object.keys(obj2));
            const intersection = new Set([...set1].filter(x => set2.has(x)));
            const union = new Set([...set1, ...set2]);
            return intersection.size / union.size;
        }
    </script>
</body>

</html>
